services:
  squid:
    image: ubuntu/squid:latest
    platform: linux/arm64
    networks:
      sandbox:
      extnet:
    volumes:
      - ./squid.conf:/etc/squid/squid.conf:ro
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "squid -k check || exit 1"]
      interval: 2s
      timeout: 2s
      retries: 3
      start_period: 3s

  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TZ: ${TZ:-America/Los_Angeles}
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-2.1.42}
        GIT_DELTA_VERSION: ${GIT_DELTA_VERSION:-0.18.2}
        BEADS_VERSION: ${BEADS_VERSION:-0.49.6}
        GO_VERSION: ${GO_VERSION:-1.23.6}
    networks:
      sandbox:
    volumes:
      - ${MOAT_WORKSPACE:-~/Repos}:/workspace:cached
      - moat-bashhistory:/commandhistory
      - moat-config:/home/node/.claude
    depends_on:
      squid:
        condition: service_healthy
    environment:
      - HTTP_PROXY=http://squid:3128
      - HTTPS_PROXY=http://squid:3128
      - http_proxy=http://squid:3128
      - https_proxy=http://squid:3128
      - NO_PROXY=localhost,127.0.0.1
      - no_proxy=localhost,127.0.0.1
      - NODE_OPTIONS=--max-old-space-size=4096
      - CLAUDE_CONFIG_DIR=/home/node/.claude
      - DEVCONTAINER=true
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
    command: sleep infinity

networks:
  sandbox:
    internal: true
  extnet:

volumes:
  moat-bashhistory:
  moat-config:
